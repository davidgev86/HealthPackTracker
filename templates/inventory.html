{% extends "layout.html" %}

{% block title %}Inventory - HPM Inventory{% endblock %}

{% block content %}
<style>
/* Responsive adjustments for filter section */
@media (max-width: 992px) {
    .filter-section .btn {
        margin-bottom: 0.5rem;
    }
    
    .filter-section .col-lg-3 {
        margin-bottom: 1rem;
    }
}
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 data-en="Inventory Management" data-es="Gestión de Inventario">
        <i class="fas fa-boxes me-2"></i>Inventory Management
    </h2>
    <div class="btn-group">
        {% if user.has_permission('edit') %}
        <a href="{{ url_for('add_item') }}" class="btn btn-primary" data-en="Add Item" data-es="Agregar Artículo">
            <i class="fas fa-plus me-2"></i>Add Item
        </a>
        <a href="{{ url_for('vendors') }}" class="btn btn-outline-secondary" data-en="Vendors" data-es="Proveedores">
            <i class="fas fa-truck me-2"></i>Vendors
        </a>

        <a href="{{ url_for('categories') }}" class="btn btn-outline-secondary" data-en="Categories" data-es="Categorías">
            <i class="fas fa-tags me-2"></i>Categories
        </a>
        {% endif %}
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title" data-en="Total Items" data-es="Total Artículos">Total Items</h5>
                <h3>{{ all_items|length if all_items else items|length }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <h5 class="card-title" data-en="Low Stock" data-es="Poco Stock">Low Stock</h5>
                <h3>{{ low_stock_count }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title" data-en="Categories" data-es="Categorías">Categories</h5>
                <h3>{{ (all_items|map(attribute='category')|unique|list|length) if all_items else (items|map(attribute='category')|unique|list|length) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title" data-en="Total Value" data-es="Valor Total">Total Value</h5>
                <h3>${{ "%.2f"|format(total_value) }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Filter Controls -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0" data-en="Filter & Actions" data-es="Filtros y Acciones">Filter & Actions</h5>
    </div>
    <div class="card-body filter-section">
        <div class="row g-3">
            <div class="col-lg-3 col-md-6">
                <label class="form-label" data-en="Search Items" data-es="Buscar Artículos">Search Items</label>
                <input type="text" class="form-control" id="searchInput" 
                       placeholder="Search by item name..." 
                       data-placeholder-en="Search by item name..." 
                       data-placeholder-es="Buscar por nombre..." 
                       onkeyup="filterItems()">
            </div>
            <div class="col-lg-3 col-md-6">
                <label class="form-label" data-en="Category" data-es="Categoría">Category</label>
                <div class="input-group">
                    <select class="form-select" onchange="applyFilter('category', this.value)">
                        <option value="" data-en="All Categories" data-es="Todas las Categorías">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category }}" {% if current_category == category %}selected{% endif %}>
                            {{ category }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-lg-2 col-md-6">
                <label class="form-label" data-en="Vendor" data-es="Proveedor">Vendor</label>
                <select class="form-select" onchange="applyFilter('vendor', this.value)">
                    <option value="" data-en="All Vendors" data-es="Todos los Proveedores">All Vendors</option>
                    {% for vendor in vendors %}
                    <option value="{{ vendor.name }}" {% if current_vendor == vendor.name %}selected{% endif %}>
                        {{ vendor.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-2 col-md-6">
                <label class="form-label" data-en="Stock Status" data-es="Estado del Stock">Stock Status</label>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-warning btn-sm {% if low_stock_filter %}active{% endif %}" 
                            onclick="toggleLowStockFilter()" 
                            data-en="Low Stock" data-es="Poco Stock">
                        <i class="fas fa-exclamation-triangle me-1"></i>Low Stock
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()" 
                            data-en="Clear" data-es="Limpiar">
                        <i class="fas fa-times me-1"></i>Clear
                    </button>
                </div>
            </div>
            <div class="col-lg-2 col-md-6">
                <label class="form-label" data-en="Actions" data-es="Acciones">Actions</label>
                <div class="d-flex gap-2 flex-wrap">
                    <div class="dropdown">
                        <button class="btn btn-success dropdown-toggle btn-sm" type="button" 
                                data-bs-toggle="dropdown" aria-expanded="false" 
                                data-en="Generate PDF" data-es="Generar PDF">
                            <i class="fas fa-file-pdf me-1"></i>Generate PDF
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('generate_shopping_list_pdf_route') }}" 
                                   data-en="Shopping List" data-es="Lista de Compras">
                                <i class="fas fa-shopping-cart me-2"></i>Shopping List</a></li>

                        </ul>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Inventory Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0" data-en="Current Inventory" data-es="Inventario Actual">Current Inventory</h5>
        {% if user.has_permission('edit') %}
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary" onclick="toggleBulkEdit()" 
                    data-en="Bulk Edit" data-es="Edición Masiva">
                <i class="fas fa-edit me-1"></i>Bulk Edit
            </button>
            <button class="btn btn-sm btn-outline-success" id="saveAllBtn" style="display: none;" onclick="saveAllChanges()" 
                    data-en="Save All" data-es="Guardar Todo">
                <i class="fas fa-save me-1"></i>Save All
            </button>
        </div>
        {% endif %}
    </div>
    <div class="card-body">
        {% if items %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th data-en="Item Name" data-es="Nombre del Artículo">Item Name</th>
                        <th data-en="Category" data-es="Categoría">Category</th>
                        <th data-en="Current Stock" data-es="Stock Actual">Current Stock</th>
                        <th data-en="Unit" data-es="Unidad">Unit</th>
                        <th data-en="Par Level" data-es="Nivel Mínimo">Par Level</th>
                        <th data-en="Unit Cost" data-es="Costo por Unidad">Unit Cost</th>
                        <th data-en="Total Value" data-es="Valor Total">Total Value</th>
                        <th data-en="Vendors" data-es="Proveedores">Vendors</th>
                        <th data-en="Status" data-es="Estado">Status</th>
                        <th data-en="Last Updated" data-es="Última Actualización">Last Updated</th>
                        <th data-en="Actions" data-es="Acciones">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr class="{% if item.is_low_stock() %}table-warning{% endif %}">
                        <td>
                            <strong>{{ item.name }}</strong>
                            {% if item.is_low_stock() %}
                            <i class="fas fa-exclamation-triangle text-warning ms-2" title="Low Stock"></i>
                            {% endif %}
                        </td>
                        <td>{{ item.category }}</td>
                        <td>
                            {% if user.has_permission('record_counts') or user.has_permission('edit') %}
                            <form method="POST" action="{{ url_for('update_count', item_name=item.name) }}" class="d-inline">
                                <div class="input-group input-group-sm" style="width: 120px;">
                                    <input type="number" class="form-control" name="count" value="{{ item.quantity }}" min="0">
                                    <button class="btn btn-outline-secondary" type="submit" title="Update Count">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>
                            </form>
                            {% else %}
                            <span class="badge bg-secondary">{{ item.quantity }}</span>
                            {% endif %}
                        </td>
                        <td>{{ item.unit }}</td>
                        <td>{{ item.par_level }}</td>
                        <td>${{ "%.2f"|format(item.unit_cost) }}</td>
                        <td>${{ "%.2f"|format(item.total_value()) }}</td>
                        <td>
                            {% if item.vendors %}
                                {% for vendor in item.vendors.split(',') %}
                                    <span class="badge bg-secondary me-1">{{ vendor.strip() }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted" data-en="No vendors" data-es="Sin proveedores">No vendors</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.is_low_stock() %}
                            <span class="badge bg-warning" data-en="Low Stock" data-es="Poco Stock">Low Stock</span>
                            {% else %}
                            <span class="badge bg-success" data-en="OK" data-es="OK">OK</span>
                            {% endif %}
                        </td>
                        <td>{{ item.last_updated or 'N/A' }}</td>
                        <td>
                            {% if user.has_permission('edit') %}
                            <a href="{{ url_for('edit_item', item_name=item.name) }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% endif %}
                            {% if user.has_permission('delete') %}
                            <form method="POST" action="{{ url_for('delete_item', item_name=item.name) }}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this item?')">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-boxes fa-3x text-muted mb-3"></i>
            <h5 class="text-muted" data-en="No inventory items found" data-es="No se encontraron artículos de inventario">No inventory items found</h5>
            <p class="text-muted" data-en="Get started by adding your first inventory item." data-es="Comience agregando su primer artículo de inventario.">Get started by adding your first inventory item.</p>
            {% if user.has_permission('edit') %}
            <a href="{{ url_for('add_item') }}" class="btn btn-primary" data-en="Add First Item" data-es="Agregar Primer Artículo">
                <i class="fas fa-plus me-2"></i>Add First Item
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-submit count updates after 2 seconds of inactivity
let countTimers = {};
document.querySelectorAll('input[name="count"]').forEach(input => {
    input.addEventListener('input', function() {
        const form = this.closest('form');
        const itemName = form.action.split('/').pop();
        
        // Clear existing timer
        if (countTimers[itemName]) {
            clearTimeout(countTimers[itemName]);
        }
        
        // Set new timer
        countTimers[itemName] = setTimeout(() => {
            form.submit();
        }, 2000);
    });
});

// Bulk edit functionality
let bulkEditMode = false;
let originalValues = {};

function toggleBulkEdit() {
    bulkEditMode = !bulkEditMode;
    const saveAllBtn = document.getElementById('saveAllBtn');
    const quantityInputs = document.querySelectorAll('input[name="count"]');
    const submitButtons = document.querySelectorAll('form button[type="submit"]');
    
    if (bulkEditMode) {
        // Store original values and disable auto-submit
        quantityInputs.forEach(function(input) {
            originalValues[input.closest('form').action] = input.value;
            input.style.backgroundColor = '#fff3cd';
            // Clear existing timers
            const itemName = input.closest('form').action.split('/').pop();
            if (countTimers[itemName]) {
                clearTimeout(countTimers[itemName]);
            }
        });
        
        // Hide individual submit buttons
        submitButtons.forEach(function(btn) {
            btn.style.display = 'none';
        });
        
        saveAllBtn.style.display = 'inline-block';
        const cancelText = currentLanguage === 'es' ? 'Cancelar' : 'Cancel';
        document.querySelector('[onclick="toggleBulkEdit()"]').innerHTML = `<i class="fas fa-times me-1"></i>${cancelText}`;
    } else {
        // Restore original values
        quantityInputs.forEach(function(input) {
            const formAction = input.closest('form').action;
            input.value = originalValues[formAction];
            input.style.backgroundColor = '';
        });
        
        // Show individual submit buttons
        submitButtons.forEach(function(btn) {
            btn.style.display = 'inline-block';
        });
        
        saveAllBtn.style.display = 'none';
        const bulkEditText = currentLanguage === 'es' ? 'Edición Masiva' : 'Bulk Edit';
        document.querySelector('[onclick="toggleBulkEdit()"]').innerHTML = `<i class="fas fa-edit me-1"></i>${bulkEditText}`;
    }
}

function saveAllChanges() {
    const quantityInputs = document.querySelectorAll('input[name="count"]');
    const promises = [];
    
    quantityInputs.forEach(function(input) {
        const formAction = input.closest('form').action;
        if (input.value !== originalValues[formAction]) {
            const form = input.closest('form');
            const formData = new FormData(form);
            
            promises.push(
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
            );
        }
    });
    
    if (promises.length > 0) {
        Promise.all(promises).then(() => {
            location.reload();
        });
    } else {
        // No changes made
        toggleBulkEdit();
    }
}

// Filter functions
function applyFilter(filterType, value) {
    const url = new URL(window.location);
    if (value) {
        url.searchParams.set(filterType, value);
    } else {
        url.searchParams.delete(filterType);
    }
    window.location.href = url.toString();
}

function toggleLowStockFilter() {
    const url = new URL(window.location);
    const currentState = url.searchParams.get('low_stock') === 'true';
    if (currentState) {
        url.searchParams.delete('low_stock');
    } else {
        url.searchParams.set('low_stock', 'true');
    }
    window.location.href = url.toString();
}

function clearFilters() {
    // Clear search input
    document.getElementById('searchInput').value = '';
    
    // Show all table rows
    filterItems();
    
    // Clear URL filters
    const url = new URL(window.location);
    url.searchParams.delete('category');
    url.searchParams.delete('vendor');
    url.searchParams.delete('low_stock');
    window.location.href = url.toString();
}

// Search functionality for main inventory
function filterItems() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const tableRows = document.querySelectorAll('tbody tr');
    let visibleCount = 0;
    
    tableRows.forEach(row => {
        const itemName = row.cells[0].textContent.toLowerCase(); // First cell contains item name
        const shouldShow = itemName.includes(searchTerm);
        
        if (shouldShow) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update the table info if search is active
    updateSearchResults(visibleCount, searchTerm);
}

function updateSearchResults(count, searchTerm) {
    // Find or create search results display
    let resultsDiv = document.getElementById('searchResults');
    if (!resultsDiv) {
        resultsDiv = document.createElement('div');
        resultsDiv.id = 'searchResults';
        resultsDiv.className = 'text-muted mb-2';
        
        // Insert before the table
        const tableWrapper = document.querySelector('.table-responsive');
        if (tableWrapper) {
            tableWrapper.parentElement.insertBefore(resultsDiv, tableWrapper);
        }
    }
    
    if (searchTerm && searchTerm.trim() !== '') {
        const searchText = currentLanguage === 'es' ? `Mostrando ${count} artículos que coinciden con "${searchTerm}"` : `Showing ${count} items matching "${searchTerm}"`;
        resultsDiv.innerHTML = `<small><i class="fas fa-search me-1"></i>${searchText}</small>`;
        resultsDiv.style.display = 'block';
    } else {
        resultsDiv.style.display = 'none';
    }
}

// Category management functions removed - use Categories page instead
</script>

<!-- Category management moved to Categories page -->

{% endblock %}
