{% extends "layout.html" %}

{% block title %}Inventory - HPM Inventory{% endblock %}

{% block content %}
<style>
/* Ensure buttons have adequate space for bilingual text */
.btn-bilingual {
    white-space: nowrap;
    overflow: visible;
    text-overflow: clip;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    line-height: 1.2;
}

.btn-bilingual small {
    font-size: 0.75em;
    opacity: 0.8;
    margin-top: 2px;
}

/* Responsive adjustments for filter section */
@media (max-width: 992px) {
    .filter-section .btn {
        margin-bottom: 0.5rem;
    }
    
    .filter-section .col-lg-3 {
        margin-bottom: 1rem;
    }
}

@media (max-width: 768px) {
    .btn-bilingual {
        min-height: 50px;
        font-size: 0.875rem;
    }
    
    .btn-bilingual small {
        font-size: 0.7em;
    }
}
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-boxes me-2"></i>Inventory Management<br>
        <small class="text-muted">Gestión de Inventario</small>
    </h2>
    <div class="btn-group">
        {% if user.has_permission('edit') %}
        <a href="{{ url_for('add_item') }}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>Add Item<br>
            <small>Agregar Artículo</small>
        </a>
        <a href="{{ url_for('vendors') }}" class="btn btn-outline-secondary">
            <i class="fas fa-truck me-2"></i>Vendors<br>
            <small>Proveedores</small>
        </a>

        <a href="{{ url_for('categories') }}" class="btn btn-outline-secondary">
            <i class="fas fa-tags me-2"></i>Categories<br>
            <small>Categorías</small>
        </a>
        {% endif %}
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5 class="card-title">Total Items<br>
                    <small>Total Artículos</small>
                </h5>
                <h3>{{ all_items|length if all_items else items|length }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <h5 class="card-title">Low Stock<br>
                    <small>Poco Stock</small>
                </h5>
                <h3>{{ low_stock_count }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5 class="card-title">Categories<br>
                    <small>Categorías</small>
                </h5>
                <h3>{{ (all_items|map(attribute='category')|unique|list|length) if all_items else (items|map(attribute='category')|unique|list|length) }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5 class="card-title">Total Value<br>
                    <small>Valor Total</small>
                </h5>
                <h3>${{ "%.2f"|format(total_value) }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Filter Controls -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Filter & Actions<br>
            <small class="text-muted">Filtros y Acciones</small>
        </h5>
    </div>
    <div class="card-body filter-section">
        <div class="row g-3">
            <div class="col-lg-3 col-md-6">
                <label class="form-label">Search Items<br>
                    <small class="text-muted">Buscar Artículos</small>
                </label>
                <input type="text" class="form-control" id="searchInput" placeholder="Search by item name... / Buscar por nombre..." onkeyup="filterItems()">
            </div>
            <div class="col-lg-3 col-md-6">
                <label class="form-label">Category<br>
                    <small class="text-muted">Categoría</small>
                </label>
                <div class="input-group">
                    <select class="form-select" onchange="applyFilter('category', this.value)">
                        <option value="">All Categories / Todas las Categorías</option>
                        {% for category in categories %}
                        <option value="{{ category }}" {% if current_category == category %}selected{% endif %}>
                            {{ category }}
                        </option>
                        {% endfor %}
                    </select>
                    {% if user.has_permission('edit') %}
                    <button class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#addCategoryModal" title="Add Category / Agregar Categoría" style="min-width: 35px;">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="showDeleteCategoryModal()" title="Delete Category / Eliminar Categoría" style="min-width: 35px;">
                        <i class="fas fa-trash"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="col-lg-2 col-md-6">
                <label class="form-label">Vendor<br>
                    <small class="text-muted">Proveedor</small>
                </label>
                <select class="form-select" onchange="applyFilter('vendor', this.value)">
                    <option value="">All Vendors / Todos los Proveedores</option>
                    {% for vendor in vendors %}
                    <option value="{{ vendor.name }}" {% if current_vendor == vendor.name %}selected{% endif %}>
                        {{ vendor.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-2 col-md-6">
                <label class="form-label">Stock Status<br>
                    <small class="text-muted">Estado del Stock</small>
                </label>
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-warning btn-sm btn-bilingual {% if low_stock_filter %}active{% endif %}" 
                            onclick="toggleLowStockFilter()" style="min-width: 110px;">
                        <span><i class="fas fa-exclamation-triangle me-1"></i>Low Stock</span>
                        <small>Poco Stock</small>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm btn-bilingual" onclick="clearFilters()" style="min-width: 90px;">
                        <span><i class="fas fa-times me-1"></i>Clear</span>
                        <small>Limpiar</small>
                    </button>
                </div>
            </div>
            <div class="col-lg-2 col-md-6">
                <label class="form-label">Actions<br>
                    <small class="text-muted">Acciones</small>
                </label>
                <div class="d-flex gap-2 flex-wrap">
                    <div class="dropdown">
                        <button class="btn btn-success dropdown-toggle btn-sm btn-bilingual" type="button" 
                                data-bs-toggle="dropdown" aria-expanded="false" style="min-width: 140px;">
                            <span><i class="fas fa-file-pdf me-1"></i>Generate PDF</span>
                            <small>Generar PDF</small>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('generate_shopping_list_pdf_route') }}">
                                <i class="fas fa-shopping-cart me-2"></i>Shopping List<br>
                                <small>Lista de Compras</small></a></li>

                        </ul>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- Inventory Table -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Current Inventory</h5>
        {% if user.has_permission('edit') %}
        <div class="btn-group">
            <button class="btn btn-sm btn-outline-primary" onclick="toggleBulkEdit()">
                <i class="fas fa-edit me-1"></i>Bulk Edit
            </button>
            <button class="btn btn-sm btn-outline-success" id="saveAllBtn" style="display: none;" onclick="saveAllChanges()">
                <i class="fas fa-save me-1"></i>Save All
            </button>
        </div>
        {% endif %}
    </div>
    <div class="card-body">
        {% if items %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Category</th>
                        <th>Current Stock</th>
                        <th>Unit</th>
                        <th>Par Level</th>
                        <th>Unit Cost</th>
                        <th>Total Value</th>
                        <th>Vendors</th>
                        <th>Status</th>
                        <th>Last Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr class="{% if item.is_low_stock() %}table-warning{% endif %}">
                        <td>
                            <strong>{{ item.name }}</strong>
                            {% if item.is_low_stock() %}
                            <i class="fas fa-exclamation-triangle text-warning ms-2" title="Low Stock"></i>
                            {% endif %}
                        </td>
                        <td>{{ item.category }}</td>
                        <td>
                            {% if user.has_permission('record_counts') or user.has_permission('edit') %}
                            <form method="POST" action="{{ url_for('update_count', item_name=item.name) }}" class="d-inline">
                                <div class="input-group input-group-sm" style="width: 120px;">
                                    <input type="number" class="form-control" name="count" value="{{ item.quantity }}" min="0">
                                    <button class="btn btn-outline-secondary" type="submit" title="Update Count">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>
                            </form>
                            {% else %}
                            <span class="badge bg-secondary">{{ item.quantity }}</span>
                            {% endif %}
                        </td>
                        <td>{{ item.unit }}</td>
                        <td>{{ item.par_level }}</td>
                        <td>${{ "%.2f"|format(item.unit_cost) }}</td>
                        <td>${{ "%.2f"|format(item.total_value()) }}</td>
                        <td>
                            {% if item.vendors %}
                                {% for vendor in item.vendors.split(',') %}
                                    <span class="badge bg-secondary me-1">{{ vendor.strip() }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">No vendors</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.is_low_stock() %}
                            <span class="badge bg-warning">Low Stock</span>
                            {% else %}
                            <span class="badge bg-success">OK</span>
                            {% endif %}
                        </td>
                        <td>{{ item.last_updated or 'N/A' }}</td>
                        <td>
                            {% if user.has_permission('edit') %}
                            <a href="{{ url_for('edit_item', item_name=item.name) }}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% endif %}
                            {% if user.has_permission('delete') %}
                            <form method="POST" action="{{ url_for('delete_item', item_name=item.name) }}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this item?')">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-boxes fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No inventory items found</h5>
            <p class="text-muted">Get started by adding your first inventory item.</p>
            {% if user.has_permission('edit') %}
            <a href="{{ url_for('add_item') }}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add First Item
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-submit count updates after 2 seconds of inactivity
let countTimers = {};
document.querySelectorAll('input[name="count"]').forEach(input => {
    input.addEventListener('input', function() {
        const form = this.closest('form');
        const itemName = form.action.split('/').pop();
        
        // Clear existing timer
        if (countTimers[itemName]) {
            clearTimeout(countTimers[itemName]);
        }
        
        // Set new timer
        countTimers[itemName] = setTimeout(() => {
            form.submit();
        }, 2000);
    });
});

// Bulk edit functionality
let bulkEditMode = false;
let originalValues = {};

function toggleBulkEdit() {
    bulkEditMode = !bulkEditMode;
    const saveAllBtn = document.getElementById('saveAllBtn');
    const quantityInputs = document.querySelectorAll('input[name="count"]');
    const submitButtons = document.querySelectorAll('form button[type="submit"]');
    
    if (bulkEditMode) {
        // Store original values and disable auto-submit
        quantityInputs.forEach(function(input) {
            originalValues[input.closest('form').action] = input.value;
            input.style.backgroundColor = '#fff3cd';
            // Clear existing timers
            const itemName = input.closest('form').action.split('/').pop();
            if (countTimers[itemName]) {
                clearTimeout(countTimers[itemName]);
            }
        });
        
        // Hide individual submit buttons
        submitButtons.forEach(function(btn) {
            btn.style.display = 'none';
        });
        
        saveAllBtn.style.display = 'inline-block';
        document.querySelector('[onclick="toggleBulkEdit()"]').innerHTML = '<i class="fas fa-times me-1"></i>Cancel';
    } else {
        // Restore original values
        quantityInputs.forEach(function(input) {
            const formAction = input.closest('form').action;
            input.value = originalValues[formAction];
            input.style.backgroundColor = '';
        });
        
        // Show individual submit buttons
        submitButtons.forEach(function(btn) {
            btn.style.display = 'inline-block';
        });
        
        saveAllBtn.style.display = 'none';
        document.querySelector('[onclick="toggleBulkEdit()"]').innerHTML = '<i class="fas fa-edit me-1"></i>Bulk Edit';
    }
}

function saveAllChanges() {
    const quantityInputs = document.querySelectorAll('input[name="count"]');
    const promises = [];
    
    quantityInputs.forEach(function(input) {
        const formAction = input.closest('form').action;
        if (input.value !== originalValues[formAction]) {
            const form = input.closest('form');
            const formData = new FormData(form);
            
            promises.push(
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
            );
        }
    });
    
    if (promises.length > 0) {
        Promise.all(promises).then(() => {
            location.reload();
        });
    } else {
        // No changes made
        toggleBulkEdit();
    }
}

// Filter functions
function applyFilter(filterType, value) {
    const url = new URL(window.location);
    if (value) {
        url.searchParams.set(filterType, value);
    } else {
        url.searchParams.delete(filterType);
    }
    window.location.href = url.toString();
}

function toggleLowStockFilter() {
    const url = new URL(window.location);
    const currentState = url.searchParams.get('low_stock') === 'true';
    if (currentState) {
        url.searchParams.delete('low_stock');
    } else {
        url.searchParams.set('low_stock', 'true');
    }
    window.location.href = url.toString();
}

function clearFilters() {
    // Clear search input
    document.getElementById('searchInput').value = '';
    
    // Show all table rows
    filterItems();
    
    // Clear URL filters
    const url = new URL(window.location);
    url.searchParams.delete('category');
    url.searchParams.delete('vendor');
    url.searchParams.delete('low_stock');
    window.location.href = url.toString();
}

// Search functionality for main inventory
function filterItems() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const tableRows = document.querySelectorAll('tbody tr');
    let visibleCount = 0;
    
    tableRows.forEach(row => {
        const itemName = row.cells[0].textContent.toLowerCase(); // First cell contains item name
        const shouldShow = itemName.includes(searchTerm);
        
        if (shouldShow) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update the table info if search is active
    updateSearchResults(visibleCount, searchTerm);
}

function updateSearchResults(count, searchTerm) {
    // Find or create search results display
    let resultsDiv = document.getElementById('searchResults');
    if (!resultsDiv) {
        resultsDiv = document.createElement('div');
        resultsDiv.id = 'searchResults';
        resultsDiv.className = 'text-muted mb-2';
        
        // Insert before the table
        const tableWrapper = document.querySelector('.table-responsive');
        if (tableWrapper) {
            tableWrapper.parentElement.insertBefore(resultsDiv, tableWrapper);
        }
    }
    
    if (searchTerm && searchTerm.trim() !== '') {
        resultsDiv.innerHTML = `<small><i class="fas fa-search me-1"></i>Showing ${count} items matching "${searchTerm}"<br>Mostrando ${count} artículos que coinciden con "${searchTerm}"</small>`;
        resultsDiv.style.display = 'block';
    } else {
        resultsDiv.style.display = 'none';
    }
}

// Category management functions
function showDeleteCategoryModal() {
    const categorySelect = document.querySelector('select[onchange*="category"]');
    const selectedCategory = categorySelect.value;
    
    if (!selectedCategory) {
        alert('Please select a category to delete.\nPor favor selecciona una categoría para eliminar.');
        return;
    }
    
    if (confirm(`Are you sure you want to delete the category "${selectedCategory}"?\n¿Estás seguro de que quieres eliminar la categoría "${selectedCategory}"?`)) {
        deleteCategory(selectedCategory);
    }
}

function deleteCategory(categoryName) {
    fetch(`/delete_category`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({category_name: categoryName})
    })
    .then(response => {
        console.log('Delete response status:', response.status, 'URL:', response.url);
        
        // Check if we're being redirected to login (authentication issue)
        if (response.status === 302 || response.url.includes('/login')) {
            throw new Error('Authentication required. Please refresh the page and log in again.\nAutenticación requerida. Por favor actualiza la página e inicia sesión nuevamente.');
        }
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Check if response is actually JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Invalid response format. Please refresh the page and try again.\nFormato de respuesta inválido. Por favor actualiza la página e intenta nuevamente.');
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Delete response data:', data); // Debug log
        if (data.success) {
            alert('Category deleted successfully!\nCategoría eliminada exitosamente!');
            location.reload();
        } else {
            alert('Error deleting category: ' + (data.message || 'Unknown error') + '\nError al eliminar categoría: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Delete category error:', error);
        alert('Error deleting category: ' + error.message + '\nError al eliminar categoría: ' + error.message);
    });
}

function addCategory() {
    const categoryName = document.getElementById('newCategoryName').value.trim();
    
    if (!categoryName) {
        alert('Please enter a category name.\nPor favor ingresa un nombre de categoría.');
        return;
    }
    
    fetch('/add_category', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({category_name: categoryName})
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Add response:', data); // Debug log
        if (data.success) {
            alert('Category added successfully!\nCategoría agregada exitosamente!');
            location.reload();
        } else {
            alert('Error adding category: ' + (data.message || 'Unknown error') + '\nError al agregar categoría: ' + (data.message || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Add category error:', error);
        alert('Error adding category: ' + error.message + '\nError al agregar categoría: ' + error.message);
    });
}
</script>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalLabel">Add New Category<br>
                    <small class="text-muted">Agregar Nueva Categoría</small>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newCategoryName" class="form-label">Category Name<br>
                        <small class="text-muted">Nombre de la Categoría</small>
                    </label>
                    <input type="text" class="form-control" id="newCategoryName" placeholder="Enter category name / Ingresa el nombre de la categoría">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel<br>
                    <small>Cancelar</small>
                </button>
                <button type="button" class="btn btn-primary" onclick="addCategory()">Add Category<br>
                    <small>Agregar Categoría</small>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
